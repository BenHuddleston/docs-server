= N1QL Support for Couchbase Transactions
:page-topic-type: concept
:imagesdir: ../../assets/images
:description: N1QL offers full support for Couchbase ACID transactions.
:tabs:
:page-partial:

// N1QL cross-references
:insert: xref:n1ql:n1ql-language-reference/insert.adoc
:upsert: xref:n1ql:n1ql-language-reference/upsert.adoc
:delete: xref:n1ql:n1ql-language-reference/delete.adoc
:update: xref:n1ql:n1ql-language-reference/update.adoc
:merge: xref:n1ql:n1ql-language-reference/merge.adoc
:select: xref:n1ql:n1ql-language-reference/selectintro.adoc
:execfunction: xref:n1ql:n1ql-language-reference/execfunction.adoc
:prepare: xref:n1ql:n1ql-language-reference/prepare.adoc
:execute: xref:n1ql:n1ql-language-reference/execute.adoc

// Learn cross-references
:transactions: xref:learn:data/transactions.adoc
:roles: xref:learn:security/roles.adoc

// Manage cross-references
:install-sample-buckets: xref:manage:manage-settings/install-sample-buckets.adoc
:sys-transactions: xref:manage:monitor/monitoring-n1ql-query.adoc#sys-transactions

// Tools cross-references
:query-workbench: xref:tools:query-workbench.adoc
:cbq-shell: xref:tools:cbq-shell.adoc
:n1ql-rest-api: xref:n1ql:n1ql-rest-api/index.adoc

// Settings cross-references
:txid: xref:settings:query-settings.adoc#txid
:tximplicit: xref:settings:query-settings.adoc#tximplicit
:txstmtnum: xref:settings:query-settings.adoc#txstmtnum
:kvtimeout: xref:settings:query-settings.adoc#kvtimeout
:txtimeout_req: xref:settings:query-settings.adoc#txtimeout_req
:txtimeout-srv: xref:settings:query-settings.adoc#txtimeout-srv
:queryTxTimeout: xref:settings:query-settings.adoc#queryTxTimeout
:atrcollection_req: xref:settings:query-settings.adoc#atrcollection_req
:atrcollection-srv: xref:settings:query-settings.adoc#atrcollection-srv
:cleanupclientattempts: xref:settings:query-settings.adoc#cleanupclientattempts
:cleanuplostattempts: xref:settings:query-settings.adoc#cleanuplostattempts
:cleanupwindow: xref:settings:query-settings.adoc#cleanupwindow
:queryCleanupClientAttempts: xref:settings:query-settings.adoc#queryCleanupClientAttempts
:queryCleanupLostAttempts: xref:settings:query-settings.adoc#queryCleanupLostAttempts
:queryCleanupWindow: xref:settings:query-settings.adoc#queryCleanupWindow
:numatrs_req: xref:settings:query-settings.adoc#numatrs_req
:numatrs-srv: xref:settings:query-settings.adoc#numatrs-srv
:queryNumAtrs: xref:settings:query-settings.adoc#queryNumAtrs
:scan_consistency: xref:settings:query-settings.adoc#scan_consistency
:durability_level: xref:settings:query-settings.adoc#durability_level
:transactional-scan-consistency: xref:settings:query-settings.adoc#transactional-scan-consistency

// Related links
:begin-transaction: xref:n1ql-language-reference/begin-transaction.adoc
:set-transaction: xref:n1ql-language-reference/set-transaction.adoc
:savepoint: xref:n1ql-language-reference/savepoint.adoc
:commit-transaction: xref:n1ql-language-reference/commit-transaction.adoc
:rollback-transaction: xref:n1ql-language-reference/rollback-transaction.adoc
:walkthrough: xref:n1ql-language-reference/transactions-walkthrough.adoc

[abstract]
{description}

Starting with Couchbase Server 7.0, you can use N1QL for Couchbase ACID transactions based on optimistic concurrency.
For more information about transactions in Couchbase, see {transactions}[Transactions].

include::partial$n1ql-language-reference/transaction-restrictions.adoc[]

TIP: For a walkthrough of how to create a transaction and use transaction statements with the Query Workbench, cbq shell, or Query REST API, see {walkthrough}[].

== Available N1QL Statements

You can use the following N1QL statements with Couchbase transactions:

* To begin a transaction, use the {begin-transaction}[BEGIN TRANSACTION] statement.
* To specify transaction settings, use the {set-transaction}[SET TRANSACTION] statement.
* To set a savepoint, use the {savepoint}[SAVEPOINT] statement.
* To rollback a transaction, use the {rollback-transaction}[ROLLBACK TRANSACTION] statement.
* To commit a transaction, use the {commit-transaction}[COMMIT TRANSACTION] statement.

== Settings and Parameters

The Query service has specific settings and parameters for Couchbase transactions:

|===
| Setting{nbsp}/ Parameter | Description

| {txid}[txid] request-level parameter
| Sets the transaction for a statement.

| {tximplicit}[tximplicit] request-level parameter
| Sets a statement as a single transaction.

| {txstmtnum}[txstmtnum] request-level parameter
| Sets the transaction statement number.

| {kvtimeout}[kvtimeout] request-level parameter
| Sets the maximum time to spend on a KV operation within a transaction before timing out.

| {durability_level}[durability_level] request-level parameter
| Sets the transactional durability level.

| {txtimeout_req}[txtimeout] request-level parameter +
{txtimeout-srv}[txtimeout] node-level setting +
{queryTxTimeout}[queryTxTimeout] cluster-level setting
| Sets the maximum time to spend on a transaction before timing out.

| {atrcollection_req}[atrcollection] request-level parameter +
{atrcollection-srv}[atrcollection] node-level setting
| Sets where the active transaction record is stored.

| {cleanupclientattempts}[cleanupclientattempts] node-level setting +
{queryCleanupClientAttempts}[queryCleanupClientAttempts] cluster-level setting

{cleanuplostattempts}[cleanuplostattempts] node-level setting +
{queryCleanupLostAttempts}[queryCleanupLostAttempts] cluster-level setting
| Sets clean up settings for expired transactions.

| {cleanupwindow}[cleanupwindow] node-level setting +
{queryCleanupWindow}[queryCleanupWindow] cluster-level setting
| Sets how frequently active transaction records are checked for cleanup.

| {numatrs_req}[numatrs] request-level parameter +
{numatrs-srv}[numatrs] node-level setting +
{queryNumAtrs}[queryNumAtrs] cluster-level setting
| Sets the total number of active transaction records.
|===

You can also use the {scan_consistency}[scan-consistency] request-level parameter to set the transactional scan consistency.
For more information, see {transactional-scan-consistency}[Transactional Scan Consistency].

== Query Tools

To create a Couchbase transaction, you can use any of the N1QL query tools: the {query-workbench}[Query Workbench], the {cbq-shell}[cbq shell], or the {n1ql-rest-api}[Query REST API].
For more information on how to create a transaction with each tool, see the following sections.

TIP: Some Couchbase SDKs provide APIs to support Couchbase transactions. For more information, see {transactions}[Transactions].

For a walkthrough of how to use each query tool to complete an example transaction, see {walkthrough}[].

=== Couchbase Transactions with the Query Workbench

To execute a transaction with multiple statements, enter each statement in the Query Editor:

* End each statement with a semicolon.
* After each statement, press kbd:[Shift+Enter] to start a new line.
* After you enter your transaction, click btn:[Execute] to execute the transaction.

To execute a single statement as a transaction, enter the statement in the Query Editor and click btn:[Run as TX].

NOTE: You don't need to specify the `txid` parameter or the `tximplicit` parameter when you enter a transaction in the Query Workbench.
If you need to specify any other parameters, you can use the query run-time preferences window.

=== Couchbase Transactions with the cbq shell

To execute a transaction with multiple statements, enter one statement at a time:

* When you start a transaction, the cbq shell session assumes all statements are part of the same transaction until you rollback or commit the transaction. 
* You don't need to set the `txid` parameter. 

NOTE: You must have cbq shell version 2.0 or above to use the automatic transaction ID functionality.

Use the `tximplicit` parameter to run a single statement as a transaction. 
You don't need to specify the `txid` parameter.

Specify parameters for a transaction with the `\SET` command.

=== Couchbase Transactions with the Query REST API

To execute a transaction with multiple statements, enter one statement at a time.
When you start a transaction, you must set the `txid` parameter for each statement to set each statement's transaction.

You can use the `tximplicit` parameter to run a single statement as a transaction.
You don't need to specify the `txid` parameter.

Set parameters for a transaction as body parameters or query parameters with the query statement.

== Monitoring

You can monitor active Couchbase transactions with the `system:transactions` catalog.
For more information, see {sys-transactions}[system:transactions].

== Permissions

When you develop a transaction with an SDK, the transaction may contain a mixture of key-value operations and query statements.

include::learn:partial$transaction-privileges.adoc[]


== Related Links

* Blog post: https://blog.couchbase.com/transactions-n1ql-couchbase-distributed-nosql/[Couchbase Transactions: Elastic, Scalable, and Distributed^].
